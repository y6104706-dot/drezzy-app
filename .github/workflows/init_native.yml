name: Init native platform folders (run once)

# Triggered manually from the GitHub Actions tab.
# This workflow generates android/ ios/ etc. using Flutter on the CI runner,
# then commits them back to main so every subsequent build has native folders.
# After this runs successfully once, you can disable or delete this workflow.

on:
  workflow_dispatch:

jobs:
  init-native:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # needed to push the commit back

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Generate native platform folders
        run: |
          # Create missing platform dirs without touching existing Dart code.
          flutter create --org com.drezzy --project-name drezzy_app \
            --platforms android,ios .

          # flutter create may regenerate pubspec.yaml / lib/ with defaults.
          # Restore our versions from git history.
          git checkout -- pubspec.yaml lib/ .gitignore

          # Restore the Firebase config that flutter create would overwrite/remove.
          git checkout -- android/app/google-services.json

      - name: Commit and push native folders
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add android/ ios/
          # If nothing changed (folders already existed) this exits 0 silently.
          git diff --cached --quiet && echo "Nothing to commit." && exit 0

          git commit -m "chore: add Flutter native platform folders (android + ios)

          Generated by the 'Init native platform folders' workflow using
          flutter create --org com.drezzy --project-name drezzy_app.
          Custom lib/, pubspec.yaml, and google-services.json were restored
          from git after generation. Safe to run multiple times. [skip ci]"

          git push
