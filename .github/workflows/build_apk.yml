name: Build Flutter APK

on:
  push:
    branches: [ 'main', 'master' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ── Java ──────────────────────────────────────────────────────────────────
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # ── Flutter (before Gradle so FLUTTER_ROOT is available) ──────────────────
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # android/local.properties is in .gitignore and never committed.
      # Gradle requires flutter.sdk to point at the Flutter SDK or it cannot
      # locate flutter.gradle and the build fails with "Flutter SDK not found".
      - name: Create android/local.properties
        run: echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties

      # ── Gradle ────────────────────────────────────────────────────────────────
      # gradle/actions/setup-gradle unconditionally validates the wrapper jar
      # checksum and cannot be disabled — it fails on the corrupted jar before
      # we can replace it. Download Gradle 8.3 directly from the official CDN
      # and use it to regenerate the wrapper jar in-place instead.
      - name: Download Gradle and regenerate wrapper
        working-directory: android
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.3-bin.zip \
               -O /tmp/gradle-8.3-bin.zip
          unzip -q /tmp/gradle-8.3-bin.zip -d /tmp/gradle-install
          /tmp/gradle-install/gradle-8.3/bin/gradle wrapper \
            --gradle-version 8.3 \
            --distribution-type all
          chmod +x gradlew

      # ── Dependencies + Build ──────────────────────────────────────────────────
      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons

      # ── Artifact ──────────────────────────────────────────────────────────────
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: drezzy-app-release
          path: build/app/outputs/flutter-apk/app-release.apk
